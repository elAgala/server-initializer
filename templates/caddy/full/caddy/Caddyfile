{
  # Put Coraza in front of every request
  order coraza_waf first
  
  # Enable metrics for Prometheus
  metrics

  # Logging - JSON format required for Promtail label extraction
  log {
    level INFO
    output file /var/log/caddy/access.log
    format json
  }

  # Allow CrowdSec globally
  crowdsec {
    api_url http://crowdsec:8080
    api_key {$CROWDSEC_API_KEY}
  }

}

# Reusable WAF snippet â€” use `import waf` in any site block
(waf) {
  coraza_waf {
    directives `
      Include /etc/caddy/coraza.conf
    `
  }
}

# Import all site configurations from sites-enabled directory
import /etc/caddy/sites-enabled/*.Caddyfile
